%
%
% TPC-D Queries
%
%

\chapter{TPC-D Abfragen}

\section*{Q2}
\label{sec:Q2}

\begin{lstlisting}
select
	s_acctbal,
	s_name,
	n_name,
	p_partkey,
	p_mfgr,
	s_address,
	s_phone,
	s_comment
from
	part,
	supplier,
	partsupp,
	nation,
	region
where
	p_partkey = ps_partkey
	and s_suppkey = ps_suppkey
	and p_size = [SIZE]
	and p_type like '%[TYPE]'
	and s_nationkey = n_nationkey
	and n_regionkey = r_regionkey
	and r_name = '[REGION]'
	and ps_supplycost = (
		select min(ps_supplycost)
		from
			partsupp, supplier,
			nation, region
		where
			p_partkey = ps_partkey
			and s_suppkey = ps_suppkey
			and s_nationkey = n_nationkey
			and n_regionkey = r_regionkey
			and r_name = '[REGION]')
	order by
		s_acctbal desc,
		n_name,
		s_name,
		p_partkey;
\end{lstlisting}

\section*{Q4}
\label{sec:Q4}

\begin{lstlisting}
select
	o_orderpriority,
	count(*) as order_count
from 
	orders
where
	o_orderdate >= date '[DATE]'
	and o_orderdate < date '[DATE]' + interval '3' month
	and exists (
		select 
			*
		from
			lineitem
		where
			l_orderkey = o_orderkey
			and l_commitdate < l_receiptdate
	)
group by
	o_orderpriority
	order by
	o_orderpriority;
\end{lstlisting}

\section*{Q7}
\label{sec:Q7}

\begin{lstlisting}
select
	supp_nation,
	cust_nation,
	l_year, sum(volume) as revenue
from (
	select
		n1.n_name as supp_nation,
		n2.n_name as cust_nation,
		extract(year from l_shipdate) as l_year,
		l_extendedprice * (1 - l_discount) as volume
	from
		supplier,
		lineitem,
		orders,
		customer,
		nation n1,
		nation n2
	where
		s_suppkey = l_suppkey
		and o_orderkey = l_orderkey
		and c_custkey = o_custkey
		and s_nationkey = n1.n_nationkey
		and c_nationkey = n2.n_nationkey
		and (
			(n1.n_name = '[NATION1]' and n2.n_name = '[NATION2]')
			or
			(n1.n_name = '[NATION2]' and n2.n_name = '[NATION1]')
		)
		and l_shipdate between date '1995-01-01' and date '1996-12-31'
) as shipping
group by
	supp_nation,
	cust_nation,
	l_year
order by
	supp_nation,
	cust_nation,
	l_year;
\end{lstlisting}

\section*{Q8}
\label{sec:Q8}

\begin{lstlisting}
select
	o_year,
	sum(
		case
			when nation = '[NATION]'
			then volume
			else 0
		end
	) / sum(volume) as mkt_share
from (
	select
		extract(year from o_orderdate) as o_year,
		l_extendedprice * (1-l_discount) as volume,
		n2.n_name as nation
	from
		part,
		supplier,
		lineitem,
		orders,
		customer,
		nation n1,
		nation n2,
		region
	where
		p_partkey = l_partkey
		and s_suppkey = l_suppkey
		and l_orderkey = o_orderkey
		and o_custkey = c_custkey
		and c_nationkey = n1.n_nationkey
		and n1.n_regionkey = r_regionkey
		and r_name = '[REGION]'
		and s_nationkey = n2.n_nationkey
		and o_orderdate between date '1995-01-01' and date '1996-12-31'
		and p_type = '[TYPE]'
) as all_nations
group by
	o_year	
order by
	o_year;
\end{lstlisting}

\section*{Q9}
\label{sec:Q9}

\begin{lstlisting}
select
	nation,
	o_year,
	sum(amount) as sum_profit
from (
	select
		n_name as nation,
		extract($\texttt{year from}$ o_orderdate) as o_year,
		l_extendedprice*(1-l_discount)-ps_supplycost*l_quantity as amount
	from
		part,
		supplier,
		lineitem,
		partsupp,
		orders,
		nation
	where
		s_suppkey = l_suppkey
		and ps_suppkey = l_suppkey
		and ps_partkey = l_partkey
		and p_partkey = l_partkey
		and o_orderkey = l_orderkey
		and s_nationkey = n_nationkey
		and p_name like '%[COLOR]%'
) as profit
group by
	nation,
	o_year
order by
	nation,
	o_year desc;
\end{lstlisting}

\section*{Q15}
\label{sec:Q15}

\begin{lstlisting}
select
	s_suppkey,
	s_name,
	s_address,
	s_phone,
	total_revenue
from
	supplier,
	revenue[STREAM_ID]
where
	s_suppkey = supplier_no
	and total_revenue = (
		select
		max(total_revenue)
		from
		revenue[STREAM_ID]
	)
order by
	s_suppkey;
\end{lstlisting}

\section*{Q16}
\label{sec:Q16}

\begin{lstlisting}
select
	p_brand,
	p_type,
	p_size,
	count(distinct ps_suppkey) as supplier_cnt
from
	partsupp,
	part
where
	p_partkey = ps_partkey
	and p_brand <> '[BRAND]'
	and p_type not like '[TYPE]%'
	and p_size in ([SIZE1], [SIZE2], [SIZE3], [SIZE4], [SIZE5], [SIZE6],
	[SIZE7], [SIZE8])
	and ps_suppkey not in (
		select
			s_suppkey
		from
			supplier
		where
			s_comment like '%Customer%Complaints%'
	)
group by
	p_brand,
	p_type,
	p_size
order by
	supplier_cnt desc,
	p_brand,
	p_type,
	p_size;
\end{lstlisting}

\section*{Q17}
\label{sec:Q17}

\begin{lstlisting}
select
	sum(l_extendedprice) / 7.0 as avg_yearly
from
	lineitem,
	part
where
	p_partkey = l_partkey
	and p_brand = '[BRAND]'
	and p_container = '[CONTAINER]'
	and l_quantity < (
		select
			0.2 * avg(l_quantity)
		from
			lineitem
		where
			l_partkey = p_partkey
	);
\end{lstlisting}

\section*{Q20}
\label{sec:Q20}

\begin{lstlisting}
select
	s_name,
	s_address
from
	supplier, nation
where
	s_suppkey in (
		select
			ps_suppkey
		from
			partsupp
		where
		ps_partkey in (
			select
			p_partkey
			from
			part
			where
			p_name like '[COLOR]%'
		)
		and ps_availqty > (
			select
				0.5 * sum(l_quantity)
			from
				lineitem
			where
				l_partkey = ps_partkey
				and l_suppkey = ps_suppkey
				and l_shipdate >= date('[DATE]')
				and l_shipdate < date('[DATE]') + interval '1' year
		)
	)
	and s_nationkey = n_nationkey
	and n_name = '[NATION]'
order by
	s_name;
\end{lstlisting}

\section*{Q21}
\label{sec:Q21}

\begin{lstlisting}
select
	s_name,
	count(*) as numwait
from
	supplier,
	lineitem l1,
	orders,
	nation
where
	s_suppkey = l1.l_suppkey
	and o_orderkey = l1.l_orderkey
	and o_orderstatus = 'F'
	and l1.l_receiptdate > l1.l_commitdate
	and exists (
		select
			*
		from
			lineitem l2
		where
			l2.l_orderkey = l1.l_orderkey
			and l2.l_suppkey <> l1.l_suppkey
	)
	and not exists (
		select
			*
		from
			lineitem l3
		where
			l3.l_orderkey = l1.l_orderkey
			and l3.l_suppkey <> l1.l_suppkey
			and l3.l_receiptdate > l3.l_commitdate
	)
	and s_nationkey = n_nationkey
	and n_name = '[NATION]'
group by
	s_name
order by
	numwait desc,
	s_name;
\end{lstlisting}

\section*{Q22}
\label{sec:Q22}

\begin{lstlisting}
select
	cntrycode,
	count(*) as numcust,
	sum(c_acctbal) as totacctbal
from (
	select
		substring(c_phone $\texttt{from}$ 1 $\texttt{for}$ 2) as cntrycode,
		c_acctbal
	from
		customer
	where
		substring(c_phone $\texttt{from}$ 1 $\texttt{for}$ 2) in
		('[I1]','[I2]','[I3]','[I4]','[I5]','[I6]','[I7]')
		and c_acctbal > (
			select
				avg(c_acctbal)
			from
				customer
			where
				c_acctbal > 0.00
				and substr (c_phone $\texttt{from}$ 1 $\texttt{for}$ 2) in
				('[I1]','[I2]','[I3]','[I4]','[I5]','[I6]','[I7]')
		)
		and not exists (
			select
				*
			from
				orders
			where
				o_custkey = c_custkey
		)
) as custsale
group by
	cntrycode
order by
	cntrycode;
\end{lstlisting}

%
% EOF
%
%