%
% Kapitel Leistungsbewertung
%
%

\chapter{Leistungsbewertung}

\section{Laufzeit- und Strukturvergleich}
\subsection{TPC-D Q2}
Findet den günstigsten Lieferanten für ein gegebenes Bauteil in einer Region. Für ein Bauteil einer bestimmten Art und Größe wird der Lieferant ermittelt, der dieses zu den günstigsten Konditionen anbietet. Gibt es mehrere Lieferanten in der gewählten Region, die das gewünschte Teil zu den günstigsten Konditionen anbieten, so werden die 100 Lieferanten mit dem höchsten Kontostand angezeigt. Von jedem Lieferanten werden der Kontostand, der Name und das Land, die Teilenummer und der Hersteller, die Lieferantenadresse, Telefonnummer und ein Kommentar angezeigt. Als Werte der Parameter SIZE, TYPE und REGION wurden die Werte aus der Abfrageüberprüfung des Benchmarks gewählt.
\begin{itemize}
	\item SIZE = 15
	\item TYPE = BRASS
	\item REGION = EUROPE
\end{itemize}
\begin{lstlisting}[caption=Abfrage Q2]
select
	[sacctbal, sname,
	 nname, ppartkey,
	 pmfgr, saddress,
	 sphone, scomment]
from
	[part, supplier,
	 partsupp, nation, region]
where
	[ppartkey = pspartkey,
	ssuppkey = pssuppkey,
	psize = 15,
	ptype contains "BRASS",
	snationkey = nnationkey,
	nregionkey = rregionkey,	
  rname = "EUROPE",
	pssupplycost = (
		select
			min(ps:pssupplycost)
		from
			[partsupp as ps, supplier as s,
			nation as n, region as r]
		where
			[ppartkey = ps:pspartkey,
		 	s:ssuppkey = ps:pssuppkey,
		 	s:snationkey = n:nnationkey,
		 	n:nregionkey = r:rregionkey,	
		 	r:rname = "EUROPE"]
	 )]
orderby[sacctbal desc,
		 nname,
	   sname,
	   ppartkey] 
first 100
\end{lstlisting}

Die erste temporäre Relation ist die Restriktion der im inneren Abfrageblock verwendeten Relationen des äußeren Blocks auf die benötigten Attribute.

\begin{lstlisting}[caption=TempRel1]
select distinct[ppartkey, pspartkey] from [part, partsupp]
\end{lstlisting}

Einschränkung der inneren Relation durch alle \emph{simplen} Prädikaten.

\begin{lstlisting}[caption=TempRel2]
select*
from[partsupp as ps, 
		supplier as s, 
		nation as n, 
		region as r]
where[s:ssuppkey = ps:pssuppkey, 
		s:snationkey = n:nnationkey, 
		n:nregionkey = r:rregionkey, 
		r:rname = "EUROPE"]
\end{lstlisting}

Join der äußeren und inneren Relationen und Berechnung der Aggregation. Da sich Optimierer und ausführbare Ebene in der Syntax für umbenannte Tupel unterscheiden muss hier auf die ausführbare Syntax der Spalten zurück gegriffen werden.

\begin{lstlisting}[caption=TempRel3]
select[pspartkey_ps, min(pssupplycost_ps) as var1]
from [txxrel1, txxrel2]
where [ppartkey = pspartkey_ps]
groupby pspartkey_ps
\end{lstlisting}

\begin{lstlisting}[caption=Entschachtelte Variante von Abfrage Q2]
select
	[sacctbal, sname, 
	nname, ppartkey, 
	pmfgr, saddress, 
	sphone, scomment]
from
	[part, supplier, 
	partsupp, nation, 
	region, txxrel3 as txxrel4]
where
	[ppartkey=pspartkey, 
	ssuppkey=pssuppkey, 
	psize=15, 
	ptype contains "BRASS", 
	snationkey=nnationkey, 
	nregionkey=rregionkey, 
	rname="EUROPE", 
	ppartkey=txxrel4:pspartkey_ps, 
	pssupplycost=txxrel4:var1]
orderby[sacctbal desc, 
		 nname, 
		 sname, 
		 ppartkey]
first 100
\end{lstlisting}

\subsection{TPC-D Q4}
Diese Abfrage ermittelt, wie gut das 
\begin{lstlisting}[caption=Abfrage Q4]
select
	[oorderpriority,
	 count(*) as ordercount]
from orders
where		
	[oorderdate >= instant("1993-07-01"),		
	oorderdate < theInstant(
		year_of(instant("1993-07-01")), 
	 	month_of(instant("1993-07-01")) + 3, 
	 	day_of(instant("1993-07-01"))
	),
	exists(
	 	select *
		from lineitem
		where
			[lorderkey = oorderkey, lcommitdate < lreceiptdate]
	)]
groupby [oorderpriority]
orderby	[oorderpriority]
\end{lstlisting}

Projektion der äußeren Relation auf die Join-Spalte.
\begin{lstlisting}[caption=TempRel1]
select distinct[oorderkey] from orders
\end{lstlisting}

Einschränkung der inneren Relation mit allen \emph{simplen} Prädikate.
\begin{lstlisting}[caption=TempRel2]
select * from lineitem where[lcommitdate < lreceiptdate]
\end{lstlisting}


Full-Outerjoin zwischen den temporären Relationen. Das \texttt{ifthenelse} Konstrukt ist notwendig, da \textsc{SECONDO} nur die zeilenbasierte Semantik des \texttt{count}-Operators unterstützt. 
\begin{lstlisting}[caption=TempRel3]
txxrel1  feed 
txxrel2  feed  
smouterjoin[oORDERKEY,lORDERKEY] 
extend[var1: ifthenelse(isempty(.lORDERKEY), 0, 1)] 
sortby[oORDERKEY asc] 
groupby[oORDERKEY;Var1: group feed sum[var1]] 
projectextend[Var1; lORDERKEY: .oORDERKEY] 
consume
\end{lstlisting}

\begin{lstlisting}[caption=Entschachtelte Variante von Q4]
select [oorderpriority, 
	count(*)as ordercount] 
from [orders, 
	txxrel3 as txxrel5] 
where [oorderdate>=instant("1993-07-01"), 
	oorderdate<theInstant(year_of(instant("1993-07-01")), 
	month_of(instant("1993-07-01")) + 3, 
	day_of(instant("1993-07-01"))), 
	oorderkey = txxrel5:lorderkey, 
	0 < txxrel5:var1] 
groupby [oorderpriority] 
orderby [oorderpriority]
\end{lstlisting}

\subsection{TPC-D Q7}
\subsection{TPC-D Q9}
\subsection{TPC-D Q15}
\subsection{TPC-D Q16}
\subsection{TPC-D Q17}
\subsection{TPC-D Q20}
\subsection{TPC-D Q21}
\subsection{TPC-D Q22}
\begin{table}[ht]
\centering
\begin{tabular}{@{}lrr@{}} \toprule
& \multicolumn{2}{c}{Laufzeit in s} \\ \cmidrule(l){2-3}
Abfrage Nr. & iterativ & entschachtelt\\ \midrule
Q2 & & \\
Q4 & & \\
Q7 & & \\
Q9 & & \\
Q15 & & \\
Q16 & & ---\\
Q17 & & \\
Q20 & & \\
Q21 & & \\
Q22 & & \\ 
\bottomrule\end{tabular}
  \caption{Laufzeit \enquote{kalt}}
  \label{tab_runtime_with_selectivity}
\end{table}

\begin{table}[ht]
\centering
\begin{tabular}{@{}crr@{}} \toprule
& \multicolumn{2}{c}{Laufzeit in s} \\ \cmidrule(l){2-3}
Abfrage Nr. & iterativ & entschachtelt\\ \midrule
Q2 & 5.347& 3.070\\
Q4 & 133.000& 0.643\\
Q7 & 2.759& 0.099\\
Q9 & & \\
Q15 & & \\
Q16 & & ---\\
Q17 & 0.588& 21.382\\
Q20 & 1.297& 0.506\\
Q21 & 1.381& 3.220\\
Q22 & 2.308& 0.938\\ 
\bottomrule\end{tabular} 
	\caption{Laufzeit \enquote{warm}}
  \label{tab_runtime}
\end{table}

\subsection{Fazit}
\subsection{Ausblick}
allgemeiner Full-Outerjoin-Operator auf Basis von Symmjoin. Unterstützung von \textbf{GROUPBY...HAVING}-Klauseln inkl. Subqueries. Geschachtelte Prädikate in Disjunktionen.

%
% EOF
%
%